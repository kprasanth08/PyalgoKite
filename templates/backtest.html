{% extends 'layout.html' %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<!-- Add Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container h-[85vh] bg-gray-900 text-gray-300 p-4">
    <div class="flex-none w-full mb-4 flex justify-between items-center">
        <h1 class="text-2xl font-semibold text-gray-100">Strategy Backtesting</h1>
        <div class="flex space-x-4">
            <a href="/dashboard" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition duration-300">
                <i class="fas fa-chart-line mr-1"></i> Dashboard
            </a>
            <a href="/strategies" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium transition duration-300">
                <i class="fas fa-cogs mr-1"></i> Strategies
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
        <!-- Left Panel - Backtest Configuration -->
        <div class="lg:col-span-1 bg-gray-800 rounded-lg p-6 overflow-y-auto">
            <h2 class="text-xl font-semibold mb-6 text-gray-100">Backtest Configuration</h2>
            
            <form id="backtestForm" class="space-y-6">
                <!-- Strategy Selection -->
                <div class="space-y-2">
                    <label for="strategySelect" class="block text-sm font-medium text-gray-300">Strategy</label>
                    <select id="strategySelect" class="w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select a strategy...</option>
                        <option value="moving_average_crossover">Moving Average Crossover</option>
                        <option value="rsi_strategy">RSI Strategy</option>
                        <option value="bollinger_bands">Bollinger Bands</option>
                        <option value="custom">Custom Strategy</option>
                    </select>
                </div>

                <!-- Symbol Selection -->
                <div class="space-y-2">
                    <label for="symbolSelect" class="block text-sm font-medium text-gray-300">Symbol</label>
                    <div class="relative">
                        <input type="text" id="symbolInput" class="w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Search symbol...">
                        <div id="symbolDropdown" class="absolute z-10 w-full bg-gray-700 border border-gray-600 rounded-md mt-1 hidden max-h-48 overflow-y-auto">
                            <!-- Symbol search results will be populated here -->
                        </div>
                    </div>
                    <input type="hidden" id="selectedSymbol" value="">
                </div>

                <!-- Date Range -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label for="startDate" class="block text-sm font-medium text-gray-300">Start Date</label>
                        <input type="date" id="startDate" class="w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="space-y-2">
                        <label for="endDate" class="block text-sm font-medium text-gray-300">End Date</label>
                        <input type="date" id="endDate" class="w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Initial Capital -->
                <div class="space-y-2">
                    <label for="initialCapital" class="block text-sm font-medium text-gray-300">Initial Capital (₹)</label>
                    <input type="number" id="initialCapital" value="100000" min="10000" step="1000" class="w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Strategy Parameters -->
                <div id="strategyParams" class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-200">Strategy Parameters</h3>
                    <!-- Dynamic parameters will be added here based on selected strategy -->
                </div>

                <!-- Run Backtest Button -->
                <button type="submit" id="runBacktestBtn" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-medium transition duration-300">
                    <i class="fas fa-play mr-2"></i>Run Backtest
                </button>
            </form>
        </div>

        <!-- Right Panel - Results -->
        <div class="lg:col-span-2 bg-gray-800 rounded-lg p-6 overflow-hidden flex flex-col">
            <!-- Results Header -->
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-100">Backtest Results</h2>
                <div id="backtestStatus" class="text-sm text-gray-400">
                    Configure and run a backtest to see results
                </div>
            </div>

            <!-- Loading State -->
            <div id="backtestLoading" class="hidden flex-1 flex items-center justify-center">
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mb-4"></div>
                    <p class="text-gray-400">Running backtest...</p>
                </div>
            </div>

            <!-- Results Content -->
            <div id="backtestResults" class="hidden flex-1 flex flex-col">
                <!-- Performance Metrics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-700 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-400" id="totalReturn">--</div>
                        <div class="text-sm text-gray-400">Total Return</div>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-400" id="sharpeRatio">--</div>
                        <div class="text-sm text-gray-400">Sharpe Ratio</div>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-purple-400" id="maxDrawdown">--</div>
                        <div class="text-sm text-gray-400">Max Drawdown</div>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-yellow-400" id="winRate">--</div>
                        <div class="text-sm text-gray-400">Win Rate</div>
                    </div>
                </div>

                <!-- Chart Container -->
                <div class="flex-1 bg-gray-700 rounded-lg p-4">
                    <div id="backtestChart" class="w-full h-full min-h-96"></div>
                </div>

                <!-- Trade Log -->
                <div class="mt-4 bg-gray-700 rounded-lg p-4 max-h-48 overflow-y-auto">
                    <h3 class="text-lg font-semibold mb-2 text-gray-200">Trade Log</h3>
                    <div id="tradeLog" class="space-y-2">
                        <!-- Trade entries will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Error State -->
            <div id="backtestError" class="hidden flex-1 flex items-center justify-center">
                <div class="text-center">
                    <div class="text-red-400 text-6xl mb-4">⚠</div>
                    <p class="text-gray-400" id="errorMessage">An error occurred while running the backtest</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script src="{{ url_for('static', filename='js/backtest-page.js') }}"></script>
{% endblock %}
