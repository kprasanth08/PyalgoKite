{% extends 'layout.html' %}

{% block extra_head %}
<style>
    /* Ensure chart takes full height of its container */
    #chartContainer, #chart {
        height: 100%;
        width: 100%;
    }
    .watchlist-item:hover {
        background-color: #2d3748; /* Slightly Lighter Dark Gray for hover (gray-800) */
    }
    .active-symbol {
        background-color: #2c5282; /* Dark Blue for active (blue-800) */
        border-left: 3px solid #63b3ed; /* Lighter Blue for border (blue-400) */
    }
    /* Custom scrollbar for webkit browsers */
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #2d3748; /* gray-800 */
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #4a5568; /* gray-600 */
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #718096; /* gray-500 */
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col h-[calc(100vh-100px)] bg-gray-900 text-gray-200 p-4 gap-4"> {# Main background: gray-900, Text: gray-200, Adjusted height #}
    <!-- Top Bar: Dashboard Title -->
    <div class="flex-none">
        <h1 class="text-2xl font-semibold text-gray-100">Trading Dashboard</h1>
    </div>

    <!-- Main Content: Watchlist and Chart -->
    <div class="flex flex-grow gap-4 overflow-hidden">
        <!-- Left Panel: Watchlist -->
        <div class="w-1/4 flex flex-col bg-gray-800 shadow-lg rounded-lg p-4"> {# Panel BG: gray-800 #}
            <h3 class="text-lg font-semibold text-gray-100 mb-3">Market Watch</h3>
            <div class="mb-3">
                <input type="text" id="symbolSearch" class="w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Search (e.g., INFY)">
                <div id="searchResults" class="mt-1 bg-gray-700 border border-gray-600 rounded-md shadow-lg hidden max-h-60 overflow-y-auto z-10 custom-scrollbar">
                    {# Search results will appear here #}
                </div>
            </div>
            <div class="flex-grow overflow-y-auto custom-scrollbar pr-1">
                <h4 class="text-md font-semibold text-gray-300 mb-2">Watchlist</h4>
                <div id="watchlist" class="space-y-2">
                    <p class="text-gray-400 text-sm">No symbols added yet.</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Chart -->
        <div class="w-3/4 flex flex-col bg-gray-800 shadow-lg rounded-lg p-4"> {# Panel BG: gray-800 #}
            <div class="flex-none flex justify-between items-center mb-3">
                <h3 id="chartSymbol" class="text-lg font-semibold text-gray-100">Live Chart</h3>
                <span id="chartStatus" class="text-sm text-gray-400"></span>
            </div>
            <div id="chartContainer" class="flex-grow relative">
                <p id="chartPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-500">Select a symbol from the watchlist to view its chart.</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io({ transports: ['websocket'] });
    const symbolSearchInput = document.getElementById('symbolSearch');
    const searchResultsDiv = document.getElementById('searchResults');
    const watchlistDiv = document.getElementById('watchlist');
    const chartContainer = document.getElementById('chartContainer');
    const chartSymbolHeader = document.getElementById('chartSymbol');
    const chartStatusSpan = document.getElementById('chartStatus');
    const chartPlaceholder = document.getElementById('chartPlaceholder');

    let watchlist = {};
    let lightweightChart = null;
    let activeInstrumentToken = null;

    socket.on('connect', () => {
        console.log('Socket.IO connected');
        chartStatusSpan.textContent = 'Connected';
        chartStatusSpan.className = 'text-sm text-green-400';
    });

    socket.on('disconnect', () => {
        console.log('Socket.IO disconnected');
        chartStatusSpan.textContent = 'Disconnected';
        chartStatusSpan.className = 'text-sm text-red-400';
    });

    socket.on('dashboard_chart_data', (data) => {
        if (data && data.instrument_token && watchlist[data.instrument_token]) {
            const symbolInfo = watchlist[data.instrument_token];
            if (symbolInfo.chartSeries && data.last_price) {
                const candle = {
                    time: Math.floor(data.timestamp ? new Date(data.timestamp).getTime() / 1000 : new Date().getTime() / 1000),
                    open: data.ohlc && data.ohlc.open !== undefined ? data.ohlc.open : data.last_price,
                    high: data.ohlc && data.ohlc.high !== undefined ? data.ohlc.high : data.last_price,
                    low: data.ohlc && data.ohlc.low !== undefined ? data.ohlc.low : data.last_price,
                    close: data.last_price
                };
                symbolInfo.chartSeries.update(candle);
                symbolInfo.lastTick = data;
                updateWatchlistItemDisplay(data.instrument_token);
            }
        }
    });

    socket.on('kite_order_update', (order) => {
        console.log('Order Update (from dashboard):', order);
    });

    symbolSearchInput.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 2) {
            searchResultsDiv.innerHTML = '';
            searchResultsDiv.classList.add('hidden');
            return;
        }
        fetch(`${window.location.origin}/search-nse-symbols?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                searchResultsDiv.innerHTML = '';
                if (data.error) {
                    searchResultsDiv.innerHTML = `<div class="p-2 text-red-400">${data.error}</div>`;
                } else if (data.length > 0) {
                    data.forEach(item => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'p-2 hover:bg-gray-600 cursor-pointer border-b border-gray-500 text-gray-200';
                        resultItem.textContent = `${item.symbol} - ${item.description || ''}`;
                        resultItem.addEventListener('click', function() {
                            addSymbolToWatchlist(item);
                            symbolSearchInput.value = '';
                            searchResultsDiv.classList.add('hidden');
                        });
                        searchResultsDiv.appendChild(resultItem);
                    });
                } else {
                    searchResultsDiv.innerHTML = '<div class="p-2 text-gray-400">No results found</div>';
                }
                searchResultsDiv.classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error searching symbols:', error);
                searchResultsDiv.innerHTML = '<div class="p-2 text-red-400">Error during search.</div>';
                searchResultsDiv.classList.remove('hidden');
            });
    });

    function addSymbolToWatchlist(item) {
        if (watchlist[item.instrument_token]) return;
        watchlist[item.instrument_token] = { symbolData: item, chartSeries: null, lastTick: null };
        renderWatchlist();
        if (!activeInstrumentToken) {
            loadChartForSymbol(item.instrument_token);
        }
        socket.emit('connect_dashboard_ws', { instrument_tokens: [item.instrument_token] });
    }

    function removeSymbolFromWatchlist(instrumentToken) {
        if (!watchlist[instrumentToken]) return;
        socket.emit('connect_dashboard_ws', { instrument_tokens_to_unsubscribe: [instrumentToken] });
        const series = watchlist[instrumentToken].chartSeries;
        if (series && lightweightChart) {
            lightweightChart.removeSeries(series);
        }
        delete watchlist[instrumentToken];
        renderWatchlist();
        if (activeInstrumentToken === instrumentToken) {
            activeInstrumentToken = null;
            chartSymbolHeader.textContent = 'Live Chart';
            chartPlaceholder.classList.remove('hidden');
            // Clear the specific series, chart object remains
            // If you want to fully clear chart, you might need to remove and recreate chart object or all its series.
            const remainingTokens = Object.keys(watchlist);
            if (remainingTokens.length > 0) {
                loadChartForSymbol(remainingTokens[0]);
            } else if (lightweightChart) {
                 // No symbols left, clear chart by removing all series
                Object.values(watchlist).forEach(entry => { // This watchlist is now empty, but if it had series...
                    if (entry.chartSeries) lightweightChart.removeSeries(entry.chartSeries);
                });
                 chartContainer.innerHTML = ''; // Clear previous chart DOM if needed before showing placeholder
                 lightweightChart = null; // Destroy chart instance
                 chartContainer.appendChild(chartPlaceholder); // Re-add placeholder
                 chartPlaceholder.classList.remove('hidden');
            }
        }
    }

    function renderWatchlist() {
        watchlistDiv.innerHTML = '';
        const tokens = Object.keys(watchlist);
        if (tokens.length === 0) {
            watchlistDiv.innerHTML = '<p class="text-gray-400 text-sm">No symbols added yet.</p>';
            return;
        }
        tokens.forEach(token => {
            const item = watchlist[token].symbolData;
            const lastTick = watchlist[token].lastTick;
            const symbolItemDiv = document.createElement('div');
            symbolItemDiv.className = `watchlist-item p-2.5 border border-gray-700 rounded-md cursor-pointer flex justify-between items-center ${token === activeInstrumentToken ? 'active-symbol' : 'bg-gray-800'}`;
            symbolItemDiv.setAttribute('data-token', token);
            symbolItemDiv.addEventListener('click', () => loadChartForSymbol(token));
            const infoDiv = document.createElement('div');
            infoDiv.className = 'flex-grow';
            const symbolName = document.createElement('span');
            symbolName.className = 'font-medium text-gray-100';
            symbolName.textContent = item.symbol;
            infoDiv.appendChild(symbolName);
            if (lastTick && lastTick.last_price !== undefined) {
                const priceSpan = document.createElement('span');
                let priceClass = 'text-gray-400';
                if (lastTick.change && lastTick.change > 0) priceClass = 'text-green-400';
                if (lastTick.change && lastTick.change < 0) priceClass = 'text-red-400';
                priceSpan.className = `block text-xs ${priceClass}`;
                priceSpan.textContent = `LTP: ${lastTick.last_price.toFixed(2)}`;
                infoDiv.appendChild(priceSpan);
            }
            const removeBtn = document.createElement('button');
            removeBtn.className = 'ml-2 text-red-400 hover:text-red-300 text-sm font-semibold';
            removeBtn.innerHTML = '&times;';
            removeBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                removeSymbolFromWatchlist(token);
            });
            symbolItemDiv.appendChild(infoDiv);
            symbolItemDiv.appendChild(removeBtn);
            watchlistDiv.appendChild(symbolItemDiv);
        });
    }

    function updateWatchlistItemDisplay(instrumentToken) {
        const itemDiv = watchlistDiv.querySelector(`[data-token="${instrumentToken}"]`);
        if (itemDiv && watchlist[instrumentToken] && watchlist[instrumentToken].lastTick) {
            const lastTick = watchlist[instrumentToken].lastTick;
            let priceSpan = itemDiv.querySelector('.text-xs');
            if (!priceSpan) {
                priceSpan = document.createElement('span');
                priceSpan.className = 'block text-xs';
                itemDiv.firstChild.appendChild(priceSpan);
            }
            let priceClass = 'text-gray-400';
            if (lastTick.change && lastTick.change > 0) priceClass = 'text-green-400';
            if (lastTick.change && lastTick.change < 0) priceClass = 'text-red-400';
            priceSpan.className = `block text-xs ${priceClass}`;
            priceSpan.textContent = `LTP: ${lastTick.last_price.toFixed(2)}`;
        }
    }

    function loadChartForSymbol(instrumentToken) {
        if (!watchlist[instrumentToken]) return;
        activeInstrumentToken = instrumentToken;
        const symbolData = watchlist[instrumentToken].symbolData;
        chartSymbolHeader.textContent = `${symbolData.symbol} (${symbolData.description || ''})`;
        chartPlaceholder.classList.add('hidden');

        if (lightweightChart) { // If chart exists, remove all series before adding new one
            Object.values(watchlist).forEach(entry => {
                if (entry.chartSeries) {
                    try { lightweightChart.removeSeries(entry.chartSeries); } catch (e) { /* ignore */ }
                    entry.chartSeries = null;
                }
            });
        } else { // Create chart if it doesn't exist
            chartContainer.innerHTML = '';
            lightweightChart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: chartContainer.clientHeight,
                layout: {
                    backgroundColor: '#1a202c', // gray-900
                    textColor: '#e2e8f0', // gray-200
                },
                grid: {
                    vertLines: { color: '#2d3748' }, // gray-800
                    horzLines: { color: '#2d3748' }, // gray-800
                },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                timeScale: {
                    borderColor: '#4a5568', // gray-600
                    timeVisible: true,
                    secondsVisible: false, // Usually not needed for daily/intraday candles
                },
            });
        }

        const newSeries = lightweightChart.addCandlestickSeries({
            upColor: '#2f855a', // Green-600
            downColor: '#c53030', // Red-600
            borderDownColor: '#c53030',
            borderUpColor: '#2f855a',
            wickDownColor: '#c53030',
            wickUpColor: '#2f855a',
        });
        watchlist[instrumentToken].chartSeries = newSeries;
        renderWatchlist();
        const tokensToSubscribe = Object.keys(watchlist);
        if (tokensToSubscribe.length > 0) {
             socket.emit('connect_dashboard_ws', { instrument_tokens: tokensToSubscribe });
        }
    }

    new ResizeObserver(entries => {
        if (entries.length === 0 || entries[0].target !== chartContainer) { return; }
        if (lightweightChart) {
            lightweightChart.applyOptions({
                width: chartContainer.clientWidth,
                height: chartContainer.clientHeight,
            });
        }
    }).observe(chartContainer);
    renderWatchlist();
});
</script>
{% endblock %}
